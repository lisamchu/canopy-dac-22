---
title: "Canopy Over Time"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
library(here)
library(purrr)
library(tidyr)
library(broom)
library(DT)
source(here("scripts/branding.R"))
load(here("data/complete_canopy_2022.RData"))
canopy_old = readRDS(here("data/canopy-2019-2021.rds"))

xwalk = read_csv(here("data/Tags-SY2021-22 Tags.csv"), show_col_types = FALSE) %>%
  select(tag = `Variable name`, tag_20_21 = `2020-21 equivalent`, tag_18_19 = `2018-19 equivalent`)
```

```{r}
all_tags = unique(na.omit(unlist(xwalk)))

canopy_old = canopy_old %>%
  mutate(expanded_success = coalesce(expanded_success, redefining_success)) %>%
  select(-redefining_success)

rn_20_21 = which(xwalk$tag_20_21 %in% names(canopy_old))

canopy_old = canopy_old %>%
  select(year, school_id, any_of(all_tags)) %>%
  rename(setNames(xwalk[["tag_20_21"]][rn_20_21], xwalk[["tag"]][rn_20_21]))

rn_18_19 = which(xwalk$tag_18_19 %in% names(canopy_old))


canopy_old = canopy_old %>%
  rename(setNames(xwalk[["tag_18_19"]][rn_18_19], xwalk[["tag"]][rn_18_19]))

canopy_old = canopy_old %>% mutate(across(everything(), as.character))

over_time = practices_data %>%
  mutate(year = "2022", school_id = as.character(school_id)) %>%
  select(school_id, year, any_of(all_tags)) %>%
  mutate(across(everything(), as.character)) %>%
  bind_rows(canopy_old)

over_time %>%
  pivot_longer(cols = starts_with("practice"), names_to = "tag") %>%
  mutate(flag = case_when(is.na(value) | value == "0" ~ 0L, TRUE ~ 1L)) %>%
  group_by(year) %>%
  mutate(n_sch_year = n_distinct(school_id)) %>%
  group_by(year, tag) %>%
  summarize(pct_practicing = mean(flag), n_sch_year = first(n_sch_year), .groups = "drop") %>%
  filter(pct_practicing > 0) ->
  long
```


```{r}
ggplot(long, aes(x = year, y = pct_practicing, group = tag)) +
  geom_line(alpha = 0.7, color = transcend_cols["teal"]) +
  geom_point(alpha = 0.9, color = transcend_cols["teal"]) +
  bar_y_scale_percent +
  labs(
    y = "Percent of schools identifying practice",
    x = "Canopy survey year",
    title = "Changes in practices over time"
  )
```

```{r, fig.height=10}
long %>% 
  mutate(year_i = as.integer(year) - 2019) %>%
  group_by(tag) %>%
  nest() %>%
  mutate(
    models = lapply(data, \(df) tidy(lm(pct_practicing ~ year_i, data = df)))
  ) -> mods 

mods %>%
  unnest(models) %>%
  filter(term == "year_i") ->
  coefs

coefs %>%
  ungroup %>%
  filter(!is.na(estimate)) %>%
  mutate(rank = rank(-abs(estimate))) %>%
  arrange(rank) %>%
  mutate(tag = reorder(factor(tag), estimate)) -> coefs

ggplot(coefs, aes(y = tag, x = estimate)) +
  geom_point(aes(color = rank), size = 3) +
  scale_color_continuous(guide = "none", trans = "reverse") +
  scale_y_discrete(labels = label_tags) +
  scale_x_continuous(labels = scales::label_percent(accuracy = 1)) +
  labs(
    x = "Percentage point change\nin schools selecting practices",
    y = "",
    title = "Average change in tagging patterns"
  ) +
  theme(axis.text.y = element_text(size = rel(0.5)))
```

```{r}
coefs %>% 
  arrange(rank) %>%
  slice(1:20) %>%
  unnest(data) %>%
  select(-year_i, -term, -statistic) %>%
  datatable() %>%
  formatRound(digits = 3,columns = c("estimate", "std.error", "p.value")) %>%
  formatPercentage(columns = "pct_practicing", digits = 1)
```

