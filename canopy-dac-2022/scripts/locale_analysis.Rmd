---
title: "Locale Analysis"
author: "Janette Avelar"
date: "5/18/2022"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    highlight: tango
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r library, include = FALSE}
library(here)
library(rio)
library(psych)
library(tidyverse)
library(ggplot2)
library(DT)
library(scales)
library(rstanarm)
library(broom.mixed)
library(gmodels)
source(here("scripts", "branding.R")) #, local = knitr::knit_global()
```

```{r modify practices data}
load(here("data", "complete_canopy_2022.RData"))
tags <- import(here("data", "Tags-SY2021-22 Tags.csv"))
```


# Cycle 3 (5.18.22)

Guiding questions/tasks & format:  
`LOCALE`: How do tagging patterns differ among rural, urban, and suburban schools?  
* table of biggest differences between categories (urban vs. rural; rural vs. suburban; suburban vs. urban)  
* odds ratio  
* visualization  

## Analysis Notes 

Data used:  
There are 4 schools not included in analysis:  
* Horizons Alternative (no NCES/self-reported data)  
* Iowa Big (multi-coded locale)  
* The Forest Schools (multi-coded locale)  
* Link Learning (multi-coded locale)  

Variables created:  
* `n` - number of schools that selected tag  
* `total_tags_locale` - total number of tags in given locale category  
* `pct_school` - percentage of schools that selected tag (n/157)  
* `pct_total_tags` - percentage of total tags within each locale (n/total_tags_locale)

```{r data set up and clean, include = FALSE}
#create totals for each practice by locale
locale_tags <- clean_data_full %>% 
  select(school_id, locale) %>% 
  left_join(practices_data, by = "school_id") %>% 
  select(school_id, locale, starts_with("practices_")) %>% 
  filter(!c(locale == "")) %>%  #Horizons Alternative; Iowa Big; The Forest Schools; Link Learning
  # mutate_at(vars(starts_with("practices_")), as.integer, na.rm = TRUE) %>% 
  pivot_longer(cols = starts_with("practices"),
               names_to = "tag",
               values_to = "n") %>% 
  select(-c(school_id)) %>% 
  group_by(locale, tag) %>% 
  mutate(n = sum(n, na.rm = TRUE)) %>% 
  unique() %>% 
#percents for each practice by locale
  ungroup() %>% 
  group_by(locale) %>% 
  mutate(total_tags_locale = sum(n),
         pct_school = n/157, #only 157 schools in the analysis
         pct_total_tags = n/total_tags_locale) #schools in each locale per tag / total tags in locale
```

## Across Locale Table and Plots

The following table and plots present the data within locales as a function of the full dataset.  

In other words, the denominator is 157 (161 total schools - 4 schools excluded from analysis either because of either missing or multi-coded data).  

As a result, the bar charts are perhaps not easily compared and/or what we were aiming for, something I realized after creating them, but I left them in for us to look at in case there's any other information they help give us, such as overall distribution of tags.  

*Note:* I haven't incorporated theming into the plots yet--I need to figure out how to download fonts and work with theming, which I am not super familiar with and ran out of time.

### Table - Tagging Differences by Locale (across all schools)

```{r diff tbl}
#create difference columns
locale_diffs <- locale_tags %>% 
  select(locale, tag, n, pct_school) %>% 
  pivot_wider(names_from = "locale",
              values_from = c("n", "pct_school")) %>% 
  janitor::clean_names() %>% 
  mutate(urb_rur_diff = abs(round(100*(pct_school_urban - pct_school_rural), 2)), #diff b/w urban & rural
         urb_sub_diff = abs(round(100*(pct_school_urban - pct_school_suburban), 2)), #diff b/w urban & suburban
         sub_rur_diff = abs(round(100*(pct_school_suburban - pct_school_rural), 2))) #diff b/w suburban & rural
#prepare data for table with nice labels
locale_diffs_tbl <- tags %>% 
  janitor::clean_names() %>% 
  select(variable_name, short_name) %>%
  rename(tag = variable_name) %>% 
  left_join(locale_diffs, by = "tag") %>% 
  select(short_name, urb_rur_diff, urb_sub_diff, sub_rur_diff,
         pct_school_urban, pct_school_suburban, pct_school_rural,
         n_urban, n_suburban, n_rural) %>% 
  mutate(urb_rur_diff = paste(round(1*urb_rur_diff, 0), "%"),
         urb_sub_diff = paste(round(1*urb_sub_diff, 0), "%"),
         sub_rur_diff = paste(round(1*sub_rur_diff, 0), "%"),
         pct_school_urban = paste(round(100*pct_school_urban, 0), "%"),
         pct_school_suburban = paste(round(100*pct_school_suburban, 0), "%"),
         pct_school_rural = paste(round(100*pct_school_rural, 0), "%")) %>% 
  rename(`Tag` = short_name,
         `Urban vs. Rural Difference` =  urb_rur_diff,
         `Urban vs. Suburban Difference` = urb_sub_diff,
         `Suburban vs. Rural Difference` = sub_rur_diff,
         `Pct. Tags (Urban)` = pct_school_urban,
         `Pct. Tags (Suburban)` = pct_school_suburban,
         `Pct. Tags (Rural)` = pct_school_rural,
         `N Tags (Urban)` = n_urban,
         `N Tags (Suburban)` = n_suburban,
         `N Tags (Rural)` = n_rural)
#table
datatable(locale_diffs_tbl)
```

### Urban vs. Rural Barchart (Across)  

```{r urb v rur viz, fig.dim = c(9, 9)}
#source("scripts/branding.R")
#prep data for viz
urb_rur_diff <- tags %>% 
  janitor::clean_names() %>% 
  select(variable_name, short_name) %>% 
  rename(tag = variable_name) %>% 
  left_join(locale_diffs, by = "tag") %>% 
  select(short_name, urb_rur_diff, pct_school_urban, pct_school_rural) %>% 
  ungroup() %>% 
  slice_max(urb_rur_diff, n = 10, with_ties = FALSE) %>% 
  mutate(urb_rur_diff = paste(round(1*urb_rur_diff, 0), "%"),
         pct_school_urban = 100*pct_school_urban,
         pct_school_rural = 100*pct_school_rural) %>% 
  pivot_longer(cols = c("pct_school_urban", "pct_school_rural"),
               names_to = "locale",
               names_prefix = "pct_school_",
               values_to = "pct")
#pct labels
urb_rur_labs <- data.frame(x = c(urb_rur_diff$short_name),
                           y = c(5 + urb_rur_diff$pct),
                           lab = c("40%", "", "36%", "", "35%", "", "34%", "", "34%", "", "33%", "", "32%", "", "32%", "", "31%", "", "31%", ""))
#reorder tags
urb_rur_diff$short_name <- factor(urb_rur_diff$short_name,
                                    levels = c(unique(paste0(urb_rur_diff$short_name))))
#side-side bar chart
urb_rur_viz <- urb_rur_diff %>% 
  ggplot(aes(short_name, pct, fill = locale)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = paste(transcend_cols)) +
  geom_text(aes(x = short_name, y = urb_rur_labs$y, label = urb_rur_labs$lab)) +
  theme_transcend_sparse +
  theme(axis.text.x = element_text(angle = -55, hjust = 0)) +
  scale_y_continuous(limits = c(0, 70)) +
  labs(x = "",
       y = "Percent of Schools Selecting Tag",
       title = "Top 10 Tags with Largest Differences between Urban and Rural Schools",
       subtitle = "Comparison across locale types - denominator = total schools")

urb_rur_viz
```

### Urban vs. Suburban Barchart (Across)

```{r urb v sub viz, fig.dim = c(9, 9)}
urb_sub_diff <- tags %>% 
  janitor::clean_names() %>% 
  select(variable_name, short_name) %>% 
  rename(tag = variable_name) %>% 
  left_join(locale_diffs, by = "tag") %>% 
  select(short_name, urb_sub_diff, pct_school_urban, pct_school_suburban) %>% 
  slice_max(urb_sub_diff, n = 10, with_ties = FALSE) %>% 
  mutate(urb_sub_diff = paste(round(1*urb_sub_diff, 0), "%"),
         pct_school_urban = 100*pct_school_urban,
         pct_school_suburban = 100*pct_school_suburban) %>% 
  pivot_longer(cols = c("pct_school_urban", "pct_school_suburban"),
               names_to = "locale",
               names_prefix = "pct_school_",
               values_to = "pct")
#pct labels
urb_sub_labs <- data.frame(x = c(urb_sub_diff$short_name),
                           y = c(5 + urb_sub_diff$pct),
                           lab = c("34%", "", "32%", "", "32%", "", "32%", "", "31%", "", "31%", "", "31%", "", "31%", "", "29%", "", "29%", ""))
#reorder tags
urb_sub_diff$short_name <- factor(urb_sub_diff$short_name,
                                    levels = c(unique(paste0(urb_sub_diff$short_name))))
#side-side bar chart
urb_sub_viz <- urb_sub_diff %>% 
  ggplot(aes(short_name, pct, fill = locale)) +
  geom_bar(stat = "identity", position = "dodge") +
  ylim(0, 70) +
  scale_fill_manual(values = paste(transcend_cols)) +
  geom_text(aes(x = short_name, y = urb_sub_labs$y, label = urb_sub_labs$lab)) +
  theme_transcend_sparse +
  theme(axis.text.x = element_text(angle = -55, hjust = 0)) +
  labs(x = "",
       y = "Percent of Schools Selecting Tag",
       title = "Top 10 Tags with Largest Differences between Urban and Suburban Schools",
       subtitle = "Comparison across locale types - denominator = total schools")

urb_sub_viz
```

### Suburban vs. Rural Barchart (Across)

```{r sub v rur viz, fig.dim = c(9, 9)}
sub_rur_diff <- tags %>% 
  janitor::clean_names() %>% 
  select(variable_name, short_name) %>% 
  rename(tag = variable_name) %>% 
  left_join(locale_diffs, by = "tag") %>% 
  select(short_name, sub_rur_diff, pct_school_rural, pct_school_suburban) %>% 
  slice_max(sub_rur_diff, n = 10, with_ties = FALSE) %>% 
  mutate(sub_rur_diff = paste(round(1*sub_rur_diff, 0), "%"),
         pct_school_rural = 100*pct_school_rural,
         pct_school_suburban = 100*pct_school_suburban) %>% 
  pivot_longer(cols = c("pct_school_rural", "pct_school_suburban"),
               names_to = "locale",
               names_prefix = "pct_school_",
               values_to = "pct")
#pct labels
sub_rur_labs <- data.frame(x = c(sub_rur_diff$short_name),
                           y = c(1 + sub_rur_diff$pct),
                           lab = c("", "8%", "", "6%", "", "6%", "", "6%", "", "6%", "", "6%", "", "6%", "", "5%", "", "5%", "", "5%"))
#reorder tags
sub_rur_diff$short_name <- factor(sub_rur_diff$short_name,
                                    levels = c(unique(paste0(sub_rur_diff$short_name))))
#side-side bar chart
sub_rur_viz <- sub_rur_diff %>% 
  ggplot(aes(short_name, pct, fill = locale)) +
  geom_bar(stat = "identity", position = "dodge") +
  ylim(0, 30) +
  scale_fill_manual(values = paste(transcend_cols)) +
  geom_text(aes(x = short_name, y = sub_rur_labs$y, label = sub_rur_labs$lab)) +
  theme_transcend_sparse +
  theme(axis.text.x = element_text(angle = -55, hjust = 0)) +
  labs(x = "",
       y = "Percent of Schools Selecting Tag",
       title = "Top 10 Tags with Largest Differences between Rural and Suburban Schools",
       subtitle = "Comparison across locale types - denominator = total schools")

sub_rur_viz
```

## Within Locale Table and Plots

In my second shot at plots, I've used tagging within locale as the basis for comparison. In other words, the denominator is equal to the number of schools within the specified locale type (95 urban schools, 32 suburban schools, and 30 rural schools = 157 total schools in analysis). This gives us an idea of the differences in tagging patterns within urban, suburban, and rural areas respectively, but I was hesitant to compare due to differences in sample size which is why I plan to also plot odds ratios in the third iteration of plotting below. Still useful to consider questions like, how much more often did suburban areas implement `x` practice than rural areas? 

```{r data set up and clean 2, include = FALSE}
#create totals for each practice by locale
locale_tags_2 <- clean_data_full %>% 
  select(school_id, school_name, locale) %>% 
  left_join(practices_data, by = "school_id") %>% 
  select(school_id, school_name, locale, starts_with("practices_")) %>% 
  filter(!c(locale == "")) %>%  #Horizons Alternative; Iowa Big; The Forest Schools; Link Learning
  group_by(locale) %>% 
  mutate(n_school = length(school_name)) %>% 
  mutate_at(vars(starts_with("practices_")), as.integer, na.rm = TRUE) %>% 
  pivot_longer(cols = starts_with("practices"),
               names_to = "tag",
               values_to = "n_tag") %>% 
  select(-c(school_id, school_name)) %>% 
  ungroup() %>% 
  group_by(locale, tag) %>% 
  mutate(n_tag = sum(n_tag, na.rm = TRUE)) %>% 
  unique() %>% 
#percents for each practice by locale
  ungroup() %>% 
  group_by(locale) %>% 
  mutate(pct_locale_tag = n_tag / n_school) #total tags for given practice within locale / total school n within locale
```

### Within Locale Table

Table mainly to show the differences the within locale analysis makes to help conceptualize. (i.e., I needed this table to think through it. Notice Pct. Tags sum in this table = 100% meaning we're accounting for all tags within each practice and analyzing the distribution across locale within it, as compared to earlier table where Pct. Tags *does not* equal 100, and reflects percentage of total schools that selected said tag as distributed across locale.)

```{r within diff tbl}
#create difference columns
locale_diffs_2 <- locale_tags_2 %>% 
  select(locale, tag, n_tag, pct_locale_tag) %>% 
  pivot_wider(names_from = "locale",
              values_from = c("n_tag", "pct_locale_tag")) %>% 
  janitor::clean_names() %>% 
  mutate(urb_rur_diff = abs(round(100*(pct_locale_tag_urban - pct_locale_tag_rural), 2)), #diff b/w urban & rural
         urb_sub_diff = abs(round(100*(pct_locale_tag_urban - pct_locale_tag_suburban), 2)), #diff b/w urban & suburban
         sub_rur_diff = abs(round(100*(pct_locale_tag_suburban - pct_locale_tag_rural), 2))) #diff b/w suburban & rural
#prepare data for table with nice labels
locale_diffs_tbl_2 <- tags %>% 
  janitor::clean_names() %>% 
  select(variable_name, short_name) %>%
  rename(tag = variable_name) %>% 
  left_join(locale_diffs_2, by = "tag") %>% 
  select(short_name, urb_rur_diff, urb_sub_diff, sub_rur_diff,
         pct_locale_tag_urban, pct_locale_tag_suburban, pct_locale_tag_rural,
         n_tag_urban, n_tag_suburban, n_tag_rural) %>% 
  mutate(urb_rur_diff = paste(round(1*urb_rur_diff, 0), "%"),
         urb_sub_diff = paste(round(1*urb_sub_diff, 0), "%"),
         sub_rur_diff = paste(round(1*sub_rur_diff, 0), "%"),
         pct_locale_tag_urban = paste(round(100*pct_locale_tag_urban, 0), "%"),
         pct_locale_tag_suburban = paste(round(100*pct_locale_tag_suburban, 0), "%"),
         pct_locale_tag_rural = paste(round(100*pct_locale_tag_rural, 0), "%")) %>% 
  rename(`Tag` = short_name,
         `Urban vs. Rural Difference` =  urb_rur_diff,
         `Urban vs. Suburban Difference` = urb_sub_diff,
         `Suburban vs. Rural Difference` = sub_rur_diff,
         `Pct. Tags (Urban)` = pct_locale_tag_urban,
         `Pct. Tags (Suburban)` = pct_locale_tag_suburban,
         `Pct. Tags (Rural)` = pct_locale_tag_rural,
         `N Tags (Urban)` = n_tag_urban,
         `N Tags (Suburban)` = n_tag_suburban,
         `N Tags (Rural)` = n_tag_rural)
#table
datatable(locale_diffs_tbl_2)
```

### Urban vs. Rural (Within)  

The biggest difference was shocking to me--68% of urban schools tagged anti-racist practices, compared to only 20% of rural schools (!!). Really curious to see how these top 3 (anti-racist practices, culturally-responsive practices, and hiring for equity and inclusion values) have or have not shifted from previous years.

```{r urb v rur viz 2, fig.dim = c(9, 9)}
#prep data
urb_rur_diff_2 <- tags %>% 
  janitor::clean_names() %>% 
  select(variable_name, short_name) %>% 
  rename(tag = variable_name) %>% 
  left_join(locale_diffs_2, by = "tag") %>% 
  select(short_name, urb_rur_diff, pct_locale_tag_urban, pct_locale_tag_rural) %>% 
  ungroup() %>% 
  slice_max(urb_rur_diff, n = 10, with_ties = FALSE) %>% 
  mutate(urb_rur_diff = paste(round(1*urb_rur_diff, 0), "%"),
         pct_locale_tag_urban = 100*pct_locale_tag_urban,
         pct_locale_tag_rural = 100*pct_locale_tag_rural) %>% 
  pivot_longer(cols = c("pct_locale_tag_urban", "pct_locale_tag_rural"),
               names_to = "locale",
               names_prefix = "pct_locale_tag_",
               values_to = "pct")
#pct labels
urb_rur_labs_2 <- data.frame(x = c(urb_rur_diff_2$short_name),
                             y = c(5 + urb_rur_diff_2$pct),
                             lab = c("49%", "", "47%", "", "42%", "", "38%", "", "29%", "", "", "25%", "21%", "", "21%", "", "", "20%", "20%", ""))
#reorder 
urb_rur_diff_2$short_name <- factor(urb_rur_diff_2$short_name,
                                    levels = c(unique(paste0(urb_rur_diff_2$short_name))))
levels(urb_rur_diff_2$short_name)
#side-side bar chart
urb_rur_viz_2 <- urb_rur_diff_2 %>% 
  ggplot(aes(reorder(short_name, urb_rur_diff), pct, fill = locale)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = paste(transcend_cols)) +
  theme_transcend_sparse +
  geom_text(aes(x = short_name, y = urb_rur_labs_2$y, label = urb_rur_labs_2$lab)) +
  theme(axis.text.x = element_text(angle = -55, hjust = 0)) +
  scale_y_continuous(limits = c(0, 100)) +
  labs(x = "",
       y = "Percent of Schools Selecting Tag",
       title = "Top 10 Tags with Largest Differences between Urban and Rural Schools",
       subtitle = "Comparison within locale types - denominator = schools within locale")

urb_rur_viz_2
```

### Urban vs. Suburban (Within)

```{r urb v sub viz 2, fig.dim = c(9, 9)}
urb_sub_diff_2 <- tags %>% 
  janitor::clean_names() %>% 
  select(variable_name, short_name) %>% 
  rename(tag = variable_name) %>% 
  left_join(locale_diffs_2, by = "tag") %>% 
  select(short_name, urb_sub_diff, pct_locale_tag_urban, pct_locale_tag_suburban) %>% 
  slice_max(urb_sub_diff, n = 10, with_ties = FALSE) %>% 
  mutate(urb_sub_diff = paste(round(1*urb_sub_diff, 0), "%"),
         pct_locale_tag_urban = 100*pct_locale_tag_urban,
         pct_locale_tag_suburban = 100*pct_locale_tag_suburban) %>% 
  pivot_longer(cols = c("pct_locale_tag_urban", "pct_locale_tag_suburban"),
               names_to = "locale",
               names_prefix = "pct_locale_tag_",
               values_to = "pct")
#pct labels
urb_sub_labs_2 <- data.frame(x = c(urb_sub_diff_2$short_name),
                             y = c(5 + urb_sub_diff_2$pct),
                             lab = c("", "31%", "", "28%", "", "26%", "", "25%", "23%", "", "", "20%", "", "20%", "19%", "", "19%", "", "", "18%"))
#reorder tags
urb_sub_diff_2$short_name <- factor(urb_sub_diff_2$short_name,
                                    levels = c(unique(paste0(urb_sub_diff_2$short_name))))
#side-side bar chart
urb_sub_viz_2 <- urb_sub_diff_2 %>% 
  ggplot(aes(short_name, pct, fill = locale)) +
  geom_bar(stat = "identity", position = "dodge") +
  ylim(0, 100) +
  geom_text(aes(x = short_name, y = urb_sub_labs_2$y, label = urb_sub_labs_2$lab)) +
  scale_fill_manual(values = paste(transcend_cols)) +
  theme_transcend_sparse +
  theme(axis.text.x = element_text(angle = -55, hjust = 0)) +
  labs(x = "",
       y = "Percent of Schools Selecting Tag",
       title = "Top 10 Tags with Largest Differences between Urban and Suburban Schools",
       subtitle = "Comparison within locale types - denominator = schools within locale")

urb_sub_viz_2
```

### Suburban vs. Rural (Within)  

```{r sub v rur viz 2, fig.dim = c(9, 9)}
sub_rur_diff_2 <- tags %>% 
  janitor::clean_names() %>% 
  select(variable_name, short_name) %>% 
  rename(tag = variable_name) %>% 
  left_join(locale_diffs_2, by = "tag") %>% 
  select(short_name, sub_rur_diff, pct_locale_tag_rural, pct_locale_tag_suburban) %>% 
  slice_max(sub_rur_diff, n = 10, with_ties = FALSE) %>% 
  mutate(sub_rur_diff = paste(round(1*sub_rur_diff, 0), "%"),
         pct_locale_tag_rural = 100*pct_locale_tag_rural,
         pct_locale_tag_suburban = 100*pct_locale_tag_suburban) %>% 
  pivot_longer(cols = c("pct_locale_tag_rural", "pct_locale_tag_suburban"),
               names_to = "locale",
               names_prefix = "pct_locale_tag_",
               values_to = "pct")
#pct labels
sub_rur_labs_2 <- data.frame(x = c(sub_rur_diff_2$short_name),
                           y = c(5 + sub_rur_diff_2$pct),
                           lab = c("", "43%", "", "33%", "", "32%", "", "32%", "", "29%", "", "29%", "", "29%", "", "25%", "", "25%", "", "25%"))
#reorder tags
sub_rur_diff_2$short_name <- factor(sub_rur_diff_2$short_name,
                                    levels = c(unique(paste0(sub_rur_diff_2$short_name))))
#side-side bar chart
sub_rur_viz_2 <- sub_rur_diff_2 %>% 
  ggplot(aes(short_name, pct, fill = locale)) +
  geom_bar(stat = "identity", position = "dodge") +
  ylim(0, 100) +
  geom_text(aes(x = short_name, y = sub_rur_labs_2$y, label = sub_rur_labs_2$lab)) +
  scale_fill_manual(values = paste(transcend_cols)) +
  theme_transcend_sparse +
  theme(axis.text.x = element_text(angle = -55, hjust = 0)) +
  labs(x = "",
       y = "Percent of Schools Selecting Tag",
       title = "Top 10 Tags with Largest Differences between Rural and Suburban Schools",
       subtitle = "Comparison within locale types - denominator = schools within locale")

sub_rur_viz_2
```

## Probability and Odds Ratios

In this final analysis, I calculated probability for each practice and converted to odds ratio in order to plot how much more or less likely a given locale was to select each tag.

```{r locale odds}
locale_odds <- locale_tags %>% 
  select(locale, tag, pct_school) %>% 
  pivot_wider(names_from = "locale",
              values_from = "pct_school",
              names_glue = "{.value}_{locale}") %>% 
  janitor::clean_names() %>% 
  mutate(odds_urban = pct_school_urban / (1 - pct_school_urban),
         odds_suburban = pct_school_suburban / (1 - pct_school_suburban),
         odds_rural = pct_school_rural / (1 - pct_school_rural),
         urb_rur_ratio = odds_urban / odds_rural,
         urb_sub_ratio = odds_urban / odds_suburban,
         sub_rur_ratio = odds_suburban / odds_rural)
```

### Urban vs. Rural (Odd Ratio)

```{r urb v rur viz 3, fig.dim = c(9, 9)}
urb_rur_odds <- tags %>% 
  janitor::clean_names() %>% 
  select(variable_name, short_name) %>% 
  rename(tag = variable_name) %>% 
  left_join(locale_odds, by = "tag") %>% 
  select(short_name, urb_rur_ratio) %>% 
  slice_max(urb_rur_ratio, n = 15, with_ties = FALSE)
#odd ratio labels labels
urb_rur_odds_lab <- data.frame(x = c(urb_rur_odds$short_name),
                           y = c(urb_rur_odds$urb_rur_ratio + .75),
                           lab = c(paste0(round(urb_rur_odds$urb_rur_ratio, 1), "x")))
#viz
urb_rur_odds_viz <- urb_rur_odds %>% 
  ggplot(aes(reorder(short_name, -urb_rur_ratio), urb_rur_ratio)) +
  geom_bar(stat = "identity", position = "dodge", fill = "#1A4C81") +
  coord_flip() +
  geom_text(aes(x = short_name, y = urb_rur_odds_lab$y, label = urb_rur_odds_lab$lab), 
            color = "#EF464B", size = 7, family = "Bebas Neue") +
  scale_color_manual(values = paste(transcend_cols)) +
  theme_transcend +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) +
  labs(x = "",
       y = "",
       title = "How Much More Likely Urban Schools were to \n Select a Tag",
       subtitle = "as compared to rural schools using raw odds ratios")
  
urb_rur_odds_viz
```

### Urban vs. Suburban (Odd Ratio)

```{r urb v sub viz 3, fig.dim = c(9, 9)}
urb_sub_odds <- tags %>% 
  janitor::clean_names() %>% 
  select(variable_name, short_name) %>% 
  rename(tag = variable_name) %>% 
  left_join(locale_odds, by = "tag") %>% 
  select(short_name, urb_sub_ratio) %>% 
  slice_max(urb_sub_ratio, n = 16, with_ties = FALSE) %>% 
  filter(!c(short_name == "dual language programming"))
#odd ratio labels labels
urb_sub_odds_lab <- data.frame(x = c(urb_sub_odds$short_name),
                           y = c(.45 + urb_sub_odds$urb_sub_ratio),
                           lab = c(paste0(round(urb_sub_odds$urb_sub_ratio, 1), "x")))
#viz
urb_sub_odds_viz <- urb_sub_odds %>% 
  ggplot(aes(reorder(short_name, -urb_sub_ratio), urb_sub_ratio)) +
  geom_bar(stat = "identity", position = "dodge", fill = "#1A4C81") +
  coord_flip() +
  geom_text(aes(x = short_name, y = urb_sub_odds_lab$y, label = urb_sub_odds_lab$lab),
            color = "#EF464B", size = 7, family = "Bebas Neue") +
  scale_fill_manual(values = paste(transcend_cols)) +
  theme_transcend +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) +
  labs(x = "",
       y = "",
       title = "How Much More Likely Urban Schools were to \n Select a Tag",
       subtitle = "as compared to suburban schools using raw odds ratios \n \n Note: dual language programming left out because no \n suburban schools selected it")
  
urb_sub_odds_viz
```

### Suburban vs. Rural (Odd Ratio)

```{r sub v rur viz 3, fig.dim = c(9, 9)}
sub_rur_odds <- tags %>% 
  janitor::clean_names() %>% 
  select(variable_name, short_name) %>% 
  rename(tag = variable_name) %>% 
  left_join(locale_odds, by = "tag") %>% 
  select(short_name, sub_rur_ratio) %>% 
  slice_max(sub_rur_ratio, n = 15, with_ties = FALSE)
#odd ratio labels labels
sub_rur_odds_lab <- data.frame(x = c(sub_rur_odds$short_name),
                           y = c(.15 + sub_rur_odds$sub_rur_ratio),
                           lab = c(paste0(round(sub_rur_odds$sub_rur_ratio, 1), "x")))
#viz
sub_rur_odds_viz <- sub_rur_odds %>% 
  ggplot(aes(reorder(short_name, -sub_rur_ratio), sub_rur_ratio)) +
  geom_bar(stat = "identity", position = "dodge", fill = "#1A4C81") +
  coord_flip() +
  geom_text(aes(x = short_name, y = sub_rur_odds_lab$y, label = sub_rur_odds_lab$lab),
            color = "#EF464B", size = 7, family = "Bebas Neue") +
  scale_fill_manual(values = paste(transcend_cols)) +
  theme_transcend +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) +
  labs(x = "",
       y = "",
       title = "How Much More Likely Suburban Schools were to \n Select a Tag",
       subtitle = "as compared to rural schools using raw odds ratios")
  
sub_rur_odds_viz
```

Save plots:
```{r, eval = FALSE}
#across plots
ggsave("urb-rur_across.png", plot = urb_rur_viz, path = here("outputs", "locale analysis"),
       width = 12, height = 8, units = "in")
ggsave("urb-sub_across.png", plot = urb_sub_viz, path = here("outputs", "locale analysis"),
       width = 12, height = 8, units = "in")
ggsave("sub-rur_across.png", plot = urb_sub_viz, path = here("outputs", "locale analysis"),
       width = 12, height = 8, units = "in")
#within plots
ggsave("urb-rur_within.png", plot = urb_rur_viz_2, path = here("outputs", "locale analysis"),
       width = 12, height = 8, units = "in")
ggsave("urb-sub_within.png", plot = urb_sub_viz_2, path = here("outputs", "locale analysis"),
       width = 12, height = 8, units = "in")
ggsave("sub-rur_within.png", plot = sub_rur_viz_2, path = here("outputs", "locale analysis"),
       width = 12, height = 8, units = "in")
#odds charts
ggsave("urb-rur_odds_chart_raw.png", plot = urb_rur_odds_viz, path = here("outputs", "locale analysis"),
       width = 12, height = 8, units = "in")
ggsave("urb-sub_odds_chart_raw.png", plot = urb_sub_odds_viz, path = here("outputs", "locale analysis"),
       width = 12, height = 8, units = "in")
ggsave("sub-rur_odds_chart_raw.png", plot = sub_rur_odds_viz, path = here("outputs", "locale analysis"),
       width = 12, height = 8, units = "in")
```


# Cycle 4 (6.3.22)

Guiding questions/tasks & format:  
`LOCALE`: How do tagging patterns differ among rural, urban, and suburban schools?  
* viz of *smallest* differences between categories (urban vs. rural; rural vs. suburban; suburban vs. urban)  
* odds ratio modeled  

## Urban vs. Rural - Smallest Diffs

```{r urb v rur small, fig.dim = c(9, 9)}
#data prep
urb_rur_diff_sm <- locale_diffs_2 %>% 
  select(tag, urb_rur_diff, pct_locale_tag_urban, pct_locale_tag_rural) %>% 
  slice_min(urb_rur_diff, n = 10, with_ties = FALSE) %>% 
  mutate(urb_rur_diff = paste(round(1*urb_rur_diff, 2), "%"),
         pct_locale_tag_urban = 100*pct_locale_tag_urban,
         pct_locale_tag_rural = 100*pct_locale_tag_rural) %>%
  pivot_longer(cols = c("pct_locale_tag_urban", "pct_locale_tag_rural"),
               names_to = "locale",
               names_prefix = "pct_locale_tag_",
               values_to = "pct")
#pct labels
urb_rur_labs_sm <- data.frame(x = c(urb_rur_diff_sm$tag),
                             y = c(2 + urb_rur_diff_sm$pct),
                             lab = c("< 1%", "", "< 1%", "", "", "< 1%", "", "< 1%", "", "< 1%", "", "< 1%", "", "< 1%", "", "1.68%", "", "1.72%", "", "1.96%"))
#reorder 
urb_rur_diff_sm$tag <- factor(urb_rur_diff_sm$tag,
                              levels = c(unique(paste0(urb_rur_diff_sm$tag))))
#levels(urb_rur_diff_sm$tag)
#side-side bar chart
urb_rur_viz_sm <- urb_rur_diff_sm %>% 
  ggplot(aes(tag, pct, fill = locale)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = paste(transcend_cols)) +
  theme_transcend_sparse +
  geom_text(aes(x = urb_rur_labs_sm$x, y = urb_rur_labs_sm$y, label = urb_rur_labs_sm$lab),
            color = "#EF464B", size = 5, family = "Bebas Neue") +
  theme(axis.text.x = element_text(angle = -55, hjust = 0)) +
  scale_x_tag() +
  scale_y_continuous(limits = c(0, 100)) +
  labs(x = "",
       y = "Percent of Schools",
       title = "Top 10 Tags with Smallest Differences between Urban and Rural Schools",
       subtitle = "Comparison within locale types - denominator = schools within locale")
urb_rur_viz_sm
```

## Urban vs. Suburban - Smallest Diffs

```{r urb v sub small, fig.dim = c(9, 9)}
#data prep
urb_sub_diff_sm <- locale_diffs_2 %>% 
  select(tag, urb_sub_diff, pct_locale_tag_urban, pct_locale_tag_suburban) %>% 
  slice_min(urb_sub_diff, n = 10, with_ties = FALSE) %>% 
  mutate(urb_sub_diff = paste(round(1*urb_sub_diff, 2), "%"),
         pct_locale_tag_urban = 100*pct_locale_tag_urban,
         pct_locale_tag_suburban = 100*pct_locale_tag_suburban) %>%
  pivot_longer(cols = c("pct_locale_tag_urban", "pct_locale_tag_suburban"),
               names_to = "locale",
               names_prefix = "pct_locale_tag_",
               values_to = "pct")
#pct labels
urb_sub_labs_sm <- data.frame(x = c(urb_sub_diff_sm$tag),
                             y = c(2 + urb_sub_diff_sm$pct),
                             lab = c("< 1%", "", "", "< 1%", "< 1%", "", "", "< 1%", "< 1%", "", "", "< 1%", "", "< 1%", "", "1.06%", "", "1.06%", "1.36%", ""))
#reorder 
urb_sub_diff_sm$tag <- factor(urb_sub_diff_sm$tag,
                              levels = c(unique(paste0(urb_sub_diff_sm$tag))))
#levels(urb_sub_diff_sm$tag)
#side-side bar chart
urb_sub_viz_sm <- urb_sub_diff_sm %>% 
  ggplot(aes(tag, pct, fill = locale)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = paste(transcend_cols)) +
  theme_transcend_sparse +
  geom_text(aes(x = urb_sub_labs_sm$x, y = urb_sub_labs_sm$y, label = urb_sub_labs_sm$lab),
            color = "#EF464B", size = 5, family = "Bebas Neue") +
  theme(axis.text.x = element_text(angle = -55, hjust = 0)) +
  scale_x_tag() +
  scale_y_continuous(limits = c(0, 100)) +
  labs(x = "",
       y = "Percent of Schools",
       title = "Top 10 Tags with Smallest Differences between Urban and Suburban Schools",
       subtitle = "Comparison within locale types - denominator = schools within locale")
urb_sub_viz_sm
```

## Suburban vs. Rural - Smallest Diffs

```{r sub v rur small, fig.dim = c(9, 9)}
#data prep
sub_rur_diff_sm <- locale_diffs_2 %>% 
  select(tag, sub_rur_diff, pct_locale_tag_suburban, pct_locale_tag_rural) %>% 
  slice_min(sub_rur_diff, n = 10, with_ties = FALSE) %>% 
  mutate(sub_rur_diff = paste(round(1*sub_rur_diff, 2), "%"),
         pct_locale_tag_suburban = 100*pct_locale_tag_suburban,
         pct_locale_tag_rural = 100*pct_locale_tag_rural) %>%
  pivot_longer(cols = c("pct_locale_tag_suburban", "pct_locale_tag_rural"),
               names_to = "locale",
               names_prefix = "pct_locale_tag_",
               values_to = "pct")
#pct labels
sub_rur_labs_sm <- data.frame(x = c(sub_rur_diff_sm$tag),
                             y = c(2 + sub_rur_diff_sm$pct),
                             lab = c("< 1%", "", "", "< 1%", "< 1%", "", "< 1%", "", "1.03 %", "", "", "1.49 %", "1.61 %", "", "1.61 %", "", "", "1.84 %", "", "1.84 %"))
#reorder 
sub_rur_diff_sm$tag <- factor(sub_rur_diff_sm$tag,
                              levels = c(unique(paste0(sub_rur_diff_sm$tag))))
#levels(sub_rur_diff_sm$tag)
#side-side bar chart
sub_rur_viz_sm <- sub_rur_diff_sm %>% 
  ggplot(aes(tag, pct, fill = locale)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = paste(transcend_cols)) +
  theme_transcend_sparse +
  geom_text(aes(x = sub_rur_labs_sm$x, y = sub_rur_labs_sm$y, label = sub_rur_labs_sm$lab),
            color = "#EF464B", size = 5, family = "Bebas Neue") +
  theme(axis.text.x = element_text(angle = -55, hjust = 0)) +
  scale_x_tag() +
  scale_y_continuous(limits = c(0, 100)) +
  labs(x = "",
       y = "Percent of Schools",
       title = "Top 10 Tags with Smallest Differences between Suburban and Rural Schools",
       subtitle = "Comparison within locale types - denominator = schools within locale")
sub_rur_viz_sm
```

```{r save plots, eval = FALSE}
#smallest differences plots
ggsave("urb-rur_small.png", plot = urb_rur_viz_sm, path = here("outputs", "locale analysis"),
       width = 12, height = 8, units = "in")
ggsave("urb-sub_small.png", plot = urb_sub_viz_sm, path = here("outputs", "locale analysis"),
       width = 12, height = 8, units = "in")
ggsave("sub-rur_small.png", plot = sub_rur_viz_sm, path = here("outputs", "locale analysis"),
       width = 12, height = 8, units = "in")
```

# Variation Across All Locales

## Variability Between All Locales

```{r all variability, fig.dim = c(9, 9)}
#data prep
#variance calculated as standard deviation within tag groups
var_all <- locale_tags_2 %>% 
  rename(pct_within = pct_locale_tag,
         n = n_tag) %>% 
  select(-c(n_school)) %>% 
  mutate(locale = str_to_lower(locale)) %>% 
  pivot_wider(names_from = "locale",
              values_from = c("n", "pct_within")) %>% #only pct_within used for differences
  select(tag, starts_with("pct_within_")) %>% 
  pivot_longer(cols = c("pct_within_urban", "pct_within_suburban", "pct_within_rural"),
               names_to = "locale",
               names_prefix = "pct_within_",
               values_to = "proportion") %>% 
  ungroup() %>% 
  group_by(tag) %>% 
  mutate(variance = sd(proportion))

#max variability plot - top 10
var_max_10 <- var_all %>% 
  group_by(locale) %>% 
  slice_max(variance, n = 10, with_ties = FALSE) %>% 
  ggplot(aes(tag, proportion, fill = locale)) + 
    geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = paste(transcend_cols)) +
  theme_transcend_sparse +
  #geom_text(aes(x = tag, y = ind_labs$y, label = ind_labs$lab),
  #          color = "#EF464B", size = 5, family = "Bebas Neue") +
  theme(axis.text.x = element_text(angle = -55, hjust = 0)) +
  #scale_y_continuous(limits = c(0, 100)) +
  scale_x_tag() +
  labs(x = "",
       y = "Tags with Most Variability",
       title = "Top 10 Tags with Largest Variability for Urban, Suburban, and Rural Schools",
       subtitle = "In order of increasing variability")

var_max_10

#min variability plot - top 10
var_min_10 <- var_all %>% 
  group_by(locale) %>% 
  slice_min(variance, n = 10, with_ties = FALSE) %>% 
  ggplot(aes(tag, proportion, fill = locale)) + 
    geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = paste(transcend_cols)) +
  theme_transcend_sparse +
  #geom_text(aes(x = tag, y = ind_labs$y, label = ind_labs$lab),
  #          color = "#EF464B", size = 5, family = "Bebas Neue") +
  theme(axis.text.x = element_text(angle = -55, hjust = 0)) +
  #scale_y_continuous(limits = c(0, 100)) +
  scale_x_tag() +
  labs(x = "",
       y = "Tags with Least Variability",
       title = "Lowest 10 Tags with Largest Variability for Urban, Suburban, and Rural Schools",
       subtitle = "In order of increasing variability")

var_min_10

#saving Figure J data
# var_min_10_dat <- var_all %>% 
#   group_by(locale) %>% 
#   slice_min(variance, n = 10, with_ties = FALSE)
#export(var_min_10_dat, "fig_j_data.csv")

#max variability plot - top 15
var_max_15 <- var_all %>% 
  group_by(locale) %>% 
  slice_max(variance, n = 15, with_ties = FALSE) %>% 
  ggplot(aes(tag, proportion, fill = locale)) + 
    geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = paste(transcend_cols)) +
  theme_transcend_sparse +
  #geom_text(aes(x = tag, y = ind_labs$y, label = ind_labs$lab),
  #          color = "#EF464B", size = 5, family = "Bebas Neue") +
  theme(axis.text.x = element_text(angle = -55, hjust = 0)) +
  #scale_y_continuous(limits = c(0, 100)) +
  scale_x_tag() +
  labs(x = "",
       y = "Tags with Most Variability",
       title = "Top 15 Tags with Largest Variability for Urban, Suburban, and Rural Schools",
       subtitle = "In order of increasing variability")

var_max_15

#min variability plot - top 15
var_min_15 <- var_all %>% 
  group_by(locale) %>% 
  slice_min(variance, n = 15, with_ties = FALSE) %>% 
  ggplot(aes(tag, proportion, fill = locale)) + 
    geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = paste(transcend_cols)) +
  theme_transcend_sparse +
  #geom_text(aes(x = tag, y = ind_labs$y, label = ind_labs$lab),
  #          color = "#EF464B", size = 5, family = "Bebas Neue") +
  theme(axis.text.x = element_text(angle = -55, hjust = 0)) +
  #scale_y_continuous(limits = c(0, 100)) +
  scale_x_tag() +
  labs(x = "",
       y = "Tags with Least Variability",
       title = "Lowest 15 Tags with Largest Variability for Urban, Suburban, and Rural Schools",
       subtitle = "In order of increasing variability")

var_min_15

#max variability plot - top 20
var_max_20 <- var_all %>% 
  group_by(locale) %>% 
  slice_max(variance, n = 20, with_ties = FALSE) %>% 
  ggplot(aes(tag, proportion, fill = locale)) + 
    geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = paste(transcend_cols)) +
  theme_transcend_sparse +
  #geom_text(aes(x = tag, y = ind_labs$y, label = ind_labs$lab),
  #          color = "#EF464B", size = 5, family = "Bebas Neue") +
  theme(axis.text.x = element_text(angle = -55, hjust = 0)) +
  #scale_y_continuous(limits = c(0, 100)) +
  scale_x_tag() +
  labs(x = "",
       y = "Tags with Most Variability",
       title = "Top 20 Tags with Largest Variability for Urban, Suburban, and Rural Schools",
       subtitle = "In order of increasing variability")

var_max_20

#min variability plot - top 20
var_min_20 <- var_all %>% 
  group_by(locale) %>% 
  slice_min(variance, n = 20, with_ties = FALSE) %>% 
  ggplot(aes(tag, proportion, fill = locale)) + 
    geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = paste(transcend_cols)) +
  theme_transcend_sparse +
  #geom_text(aes(x = tag, y = ind_labs$y, label = ind_labs$lab),
  #          color = "#EF464B", size = 5, family = "Bebas Neue") +
  theme(axis.text.x = element_text(angle = -55, hjust = 0)) +
  #scale_y_continuous(limits = c(0, 100)) +
  scale_x_tag() +
  labs(x = "",
       y = "Tags with Least Variability",
       title = "Lowest 20 Tags with Largest Variability for Urban, Suburban, and Rural Schools",
       subtitle = "In order of increasing variability")

var_min_20
```

Save plots

```{r save variance plots, eval = FALSE}
#variability across tags
#top 10
ggsave("lg-tag-variability-10.png", plot = var_max_10, path = here("outputs", "locale analysis"),
       width = 12, height = 8, units = "in")
ggsave("sm-tag-variability-10.png", plot = var_min_10, path = here("outputs", "locale analysis"),
       width = 12, height = 8, units = "in")
#top 15
ggsave("lg-tag-variability-15.png", plot = var_max_15, path = here("outputs", "locale analysis"),
       width = 12, height = 8, units = "in")
ggsave("sm-tag-variability-15.png", plot = var_min_15, path = here("outputs", "locale analysis"),
       width = 12, height = 8, units = "in")
#top 20
ggsave("lg-tag-variability-20.png", plot = var_max_20, path = here("outputs", "locale analysis"),
       width = 12, height = 8, units = "in")
ggsave("sm-tag-variability-20.png", plot = var_min_20, path = here("outputs", "locale analysis"),
       width = 12, height = 8, units = "in")
```

# Models

## Controlling for Race and SES  

The first model uses percentage of black students, hispanic students, locale, as well as free/reduced price lunch percent, students with disabilities percent, and percent of English learners.  

The plot details the top 10 absolute effects for each demographic variable listed above, as drawn from Gregor's work last year.

```{r data prep}
mod_prep <- clean_data_full %>% 
  select(school_id, starts_with("practices_"), locale, ends_with("_percent"), self_reported_total_enrollment) %>% 
  pivot_longer(cols = starts_with("practices"),
               names_to = "tag",
               values_to = "value") %>% 
  mutate(locale_urban = ifelse(locale=="Urban", 1, 0),
         locale_rural = ifelse(locale=="Rural", 1, 0),
         locale_suburban = ifelse(locale=="Suburban", 1, 0)) %>% 
  select(-locale)

##from Gregor's code:
#first will run black percent and hispanic percent as controls
one_vars = c("self_reported_total_enrollment", "black_percent", "hispanic_percent", "locale_urban", "locale_rural", "locale_suburban", "frpl_percent", "swd_percent", "ell_percent")

logistic_one_dat = 
  mod_prep %>%
  select(value, tag, one_of(one_vars)) %>%
  na.omit() %>%
  group_by(tag) %>%
  # scaling non-binary predictors
  mutate_at(vars(
    c(
      "self_reported_total_enrollment",
      "black_percent",
      "hispanic_percent",
      "frpl_percent",
      "swd_percent",
      "ell_percent"
    )
  ), scale)

one_form = as.formula(paste("value", "~", paste(one_vars, collapse = "+")))
#plot(xm, "areas", prob = 0.9, prob_outer = 1)

bayes_mods = list()

for(this_tag in unique(mod_prep$tag)) {
  bayes_mods[[this_tag]] = stan_glm(
    one_form,
    data = filter(logistic_one_dat, tag == this_tag),
    family = binomial(link = "logit"),
    prior = student_t( #I'm not familiar with the functions in this loop, does df need to change within student_t()?
      df = 7,
      location = 0,
      scale = 2.5
    )
  )
  
}

bayes_tidy = lapply(bayes_mods, tidy) %>%
  bind_rows(.id = "response") %>%
  filter(term != "(Intercept)") %>%
  mutate(
    nice_tag = label_tags(response),
    nice_demog = factor(label_dems(term))
  )

## top 10 absolute effects per demo:

bayes_facet_dat = bayes_tidy %>% group_by(nice_demog) %>%
  arrange(desc(abs(estimate))) %>%
  slice(1:10)

bayes_facet = 
  ggplot(bayes_facet_dat,
    aes(y = exp(estimate),
        x = reorder_within(nice_tag, estimate, within = nice_demog, fun = mean),
    )) +
  geom_col() + 
  labs(y = "Odds multiplier",
       x = "", 
       #fill = "Demographic",
       title = "Top 10 tags most/least related to each demographic") +
  facet_wrap(~ nice_demog, scales = "free_y") +
  scale_y_continuous(
    trans = "log",
    breaks = c(.0625, .125, .25, .5, 1, 2, 4, 8, 16),
    labels = c("1/16", "1/8", "1/4", "1/2", "1", "2", "4", "8", "16"),
    expand = expansion(0, 0)
  ) +
  scale_x_reordered() + 
  coord_flip() +
  guides(fill = "none") +
  theme(axis.text = element_text(size = 8), strip.text = element_text(size = rel(0.6)),
        panel.grid.major.y = element_blank(),
        axis.text.x = element_text(angle = -90, vjust = 0.5, hjust = 0))

bayes_facet
```

## Controlling for Aggregate BIPOC Population

The second model uses the same demographic variables, but rather than drawing from black and hispanic percentages, it uses an overall BIPOC student percentage (as calculated by non-white percent). I recognize this may not be super useful for reporting, but I was interested to see if there were any significant differences between majority-majority and majority-minority schools when racial demographics are not disaggregated.

```{r model 2 - bipoc}
#also run bipoc percent (all non-white)?
mod_prep2 <- clean_data_full %>% 
  select(school_id, starts_with("practices_"), locale, ends_with("_percent"), self_reported_total_enrollment) %>% 
  pivot_longer(cols = starts_with("practices"),
               names_to = "tag",
               values_to = "value") %>% 
  mutate(locale_urban = ifelse(locale=="Urban", 1, 0),
         locale_rural = ifelse(locale=="Rural", 1, 0),
         locale_suburban = ifelse(locale=="Suburban", 1, 0),
         non_white_percent = 1 - white_percent) %>% 
  select(-c(locale, aian_percent, asian_percent, black_percent, hispanic_percent, nhpi_percent, multiple_percent))

##from Gregor's code:
#first will run black percent and hispanic percent as controls
one_vars2 = c("self_reported_total_enrollment", "non_white_percent", "locale_urban", "locale_rural", "locale_suburban", "frpl_percent", "swd_percent", "ell_percent")

logistic_one_dat2 = 
  mod_prep2 %>%
  select(value, tag, one_of(one_vars2)) %>%
  na.omit() %>%
  group_by(tag) %>%
  # scaling non-binary predictors
  mutate_at(vars(
    c(
      "self_reported_total_enrollment",
      "non_white_percent",
      "frpl_percent",
      "swd_percent",
      "ell_percent"
    )
  ), scale)

one_form2 = as.formula(paste("value", "~", paste(one_vars2, collapse = "+")))
#plot(xm, "areas", prob = 0.9, prob_outer = 1)

bayes_mods2 = list()

for(this_tag in unique(mod_prep2$tag)) {
  bayes_mods2[[this_tag]] = stan_glm(
    one_form2,
    data = filter(logistic_one_dat2, tag == this_tag),
    family = binomial(link = "logit"),
    prior = student_t(
      df = 7,
      location = 0,
      scale = 2.5
    )
  )
  
}

bayes_tidy2 = lapply(bayes_mods2, tidy) %>%
  bind_rows(.id = "response") %>%
  filter(term != "(Intercept)") %>%
  mutate(
    nice_tag = label_tags(response),
    nice_demog = factor(label_dems(term))
  )

## top 10 absolute effects per demo:

bayes_facet_dat2 = bayes_tidy2 %>% group_by(nice_demog) %>%
  arrange(desc(abs(estimate))) %>%
  slice(1:10)

bayes_facet2 = 
  ggplot(bayes_facet_dat2,
    aes(y = exp(estimate),
        x = reorder_within(nice_tag, estimate, within = nice_demog, fun = mean),
    )) +
  geom_col() + 
  labs(y = "Odds multiplier",
       x = "", 
       #fill = "Demographic",
       title = "Top 10 tags most/least related to each demographic") +
  facet_wrap(~ nice_demog, scales = "free_y") +
  scale_y_continuous(
    trans = "log",
    breaks = c(.125, .25, .5, 1, 2, 4, 8),
    labels = c("1/8", "1/4", "1/2", "1", "2", "4", "8"),
    expand = expansion(0, 0)
  ) +
  scale_x_reordered() + 
  coord_flip() +
  guides(fill = "none") +
  theme(axis.text = element_text(size = 8), strip.text = element_text(size = rel(0.6)),
        panel.grid.major.y = element_blank(),
        axis.text.x = element_text(angle = -90, vjust = 0.5, hjust = 0))

bayes_facet2
```


Some of the outcomes from this method and model are coming out strange. Notice there's some columns extending beyond the plot dimensions, something which I don't see in last year's work and because I'm unfamiliar with some of these functions and somewhat new to Bayesian approaches I haven't been able to trouble shoot here. *Gregor* - Can you take a look at some of this code and see what's going on?  

In the meantime, I also ran the locale models with predictors using a different logistic regression approach:

## Alternate Model

*also coming out weird, so ignore this*

```{r glm log regression locale, eval = FALSE}
########## ALL COMING OUT WEIRD, IGNORE ##################
#black and hispanic percent
glm_prep <- clean_data_full %>% 
  select(school_id, starts_with("practices_"), locale, ends_with("_percent"), self_reported_total_enrollment) %>% 
  mutate(non_white_percent = 1 - white_percent,
         locale = recode(locale,
           Urban = "_urban",
           Suburban = "_suburban",
           Rural = "_rural"
         )) %>% 
  pivot_longer(cols = starts_with("practices"),
               names_to = "tag",
               values_to = "value") %>% 
  #na.omit() %>% #kept in because it was used in previous modeling, but may reconsider
  group_by(tag) %>% 
  #scaling non-binary predictors
  mutate_at(vars(c(ends_with("_percent"))), scale)
######  model to build from ########
glm1 <- glm(value ~ 1 + black_percent + hispanic_percent + frpl_percent, 
            data = glm_prep, family = "binomial")
summary(glm1)
#vector for predictor vars
glm1_vars = c("black_percent", "hispanic_percent", "locale", "frpl_percent")
#use vector to build model for loop
glm1_form = as.formula(paste("value", "~", paste(glm1_vars, collapse = "+")))

glm1_mods = list()

for(this_tag in unique(glm_prep$tag)) {
  glm1_mods[[this_tag]] = glm(
    glm1_form,
    data = filter(glm_prep, tag == this_tag),
    family = "binomial")
  
}

glm1_tidy = lapply(glm1_mods, tidy) %>%
  bind_rows(.id = "response") %>%
  filter(term != "(Intercept)") %>%
  mutate(
    nice_tag = label_tags(response),
    nice_demog = factor(label_dems(term))
  )

## top 10 absolute effects per demo:
glm1_facet_dat = glm1_tidy %>% group_by(nice_demog) %>%
  arrange(desc(abs(estimate))) %>%
  slice(1:10)

glm1_facet = 
  ggplot(glm1_facet_dat,
    aes(y = exp(estimate),
        x = reorder_within(nice_tag, estimate, within = nice_demog, fun = mean),
    )) +
  geom_col() + 
  labs(y = "Odds multiplier",
       x = "", 
       #fill = "Demographic",
       title = "Top 10 tags most/least related to each demographic") +
  facet_wrap(~ nice_demog, scales = "free_y") +
  scale_y_continuous(
    trans = "log",
    breaks = c(.0625, .125, .25, .5, 1, 2, 4, 8, 16),
    labels = c("1/16", "1/8", "1/4", "1/2", "1", "2", "4", "8", "16"),
    expand = expansion(0, 0)
  ) +
  scale_x_reordered() + 
  coord_flip() +
  guides(fill = "none") +
  theme(axis.text = element_text(size = 8), strip.text = element_text(size = rel(0.6)),
        panel.grid.major.y = element_blank(),
        axis.text.x = element_text(angle = -90, vjust = 0.5, hjust = 0))

glm1_facet

#bipoc percent
```


```{r save model plots, eval = FALSE}
#black and hispanic percent as variable in odds model
ggsave("locale-odds-model-top10.png", plot = bayes_facet, path = here("outputs", "locale analysis"), 
       width = 20, height = 12, units = "in")
#nonwhite/bipoc percent as variable in odds model
ggsave("locale-bipoc-odds-model-top10.png", plot = bayes_facet2, path = here("outputs", "locale analysis"), 
       width = 20, height = 12, units = "in")
```

